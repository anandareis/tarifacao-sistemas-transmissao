<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarifação - Relatório de Saída</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="script.js"></script>
</head>
<body>
    <h1>Tarifação do Sistema de Transmissão</h1>
    <h2>Relatório de Saída</h2>
    <!-- Dados do Sistema -->
    <div class="conteudo">
        <h3>Dados do Sistema</h3>
    </div>
    <div class="conteudo">
        <h4>Dados das barras</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Barra</div>
                <div class="tabela-celula">Capacidade Instalada (MW)</div>
                <div class="tabela-celula">Potência Gerada (MW)</div>
                <div class="tabela-celula">Potência Consumida (MW)</div>
            </div>
            {% for barra in barras %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ barra.numero }}</div>
                <div class="tabela-celula">{{ barra.capacidade_instalada }}</div>
                <div class="tabela-celula">{{ barra.potencia_gerada }}</div>
                <div class="tabela-celula">{{ barra.potencia_consumida }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="conteudo">
        <h4>Dados dos Circuitos</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Circuito</div>
                <div class="tabela-celula">Barra de Origem</div>
                <div class="tabela-celula">Barra de Destino</div>
                <div class="tabela-celula">Capacidade (MW)</div>
                <div class="tabela-celula">Custo (R$)</div>
                <div class="tabela-celula">Fluxo de Potência (MW)</div>
            </div>
            {% for circuito in circuitos %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ circuito.numero }}</div>
                <div class="tabela-celula">{{ circuito.origem.numero }}</div>
                <div class="tabela-celula">{{ circuito.destino.numero }}</div>
                <div class="tabela-celula">{{ circuito.capacidade }}</div>
                <div class="tabela-celula">{{ circuito.custo_anual }}</div>
                <div class="tabela-celula">{{ circuito.fluxo_potencia }}</div>
            </div>
            {% endfor %}
        </div>
        <p>Custo total da transmissão (CTT): <strong>R$ {{ f(circuitos.construir_vetor_custos_anuais() | sum) }}</strong></p>
    </div>
    <!-- Tarifas Nodais -->
    <div class="conteudo">
        <h3>Tarifas Nodais</h3>
        <p>As tarifas do CTU são calculadas por barra, como mostrado na tabela.</p>
        <p>As tarifas do CTN são:</p>
        <p>Para geração, <strong>kg = {{ f(ctn['kg']) }}</strong></p>
        <p>Para carga, <strong>kc = {{ f(ctn['kc']) }}</strong></p>
    </div>
    <div class="conteudo">
        <h4>Dados de Geração</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Barra</div>
                <div class="tabela-celula">Tarifa Locacional</div>
                <div class="tabela-celula">Encargo Locacional</div>
                <div class="tabela-celula">Encargo Selo</div>
                <div class="tabela-celula">Encargo Total</div>
            </div>
            {% for barra in barras %}
            {% if barra.potencia_gerada > 0 or barra.capacidade_instalada > 0 %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ barra.numero }}</div>
                <div class="tabela-celula">{{ f(d(barra.encargos['geracao']['CTU'], barra.potencia_gerada)) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['geracao']['CTU']) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['geracao']['CTN']) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['geracao']['CTU'] + barra.encargos['geracao']['CTN']) }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="conteudo">
        <h4>Dados de Carga</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Barra</div>
                <div class="tabela-celula">Tarifa Locacional</div>
                <div class="tabela-celula">Encargo Locacional</div>
                <div class="tabela-celula">Encargo Selo</div>
                <div class="tabela-celula">Encargo Total</div>
            </div>
            {% for barra in barras %}
            {% if barra.potencia_consumida > 0 %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ barra.numero }}</div>
                <div class="tabela-celula">{{ f(d(barra.encargos['carga']['CTU'], -barra.potencia_consumida)) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['carga']['CTU']) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['carga']['CTN']) }}</div>
                <div class="tabela-celula">{{ f(barra.encargos['carga']['CTU'] + barra.encargos['carga']['CTN']) }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="conteudo">
        {% if corrigido_nodal %}
        <p>Para esse cenário operativo, foi necessário fazer a correção de encargos negativos. Os valores finais são os valores corrigidos.</p>
        {% endif %}
        <h4>Encargos e tarifas finais</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Barra</div>
                <div class="tabela-celula">Encargo Final de Geração</div>
                <div class="tabela-celula">Tarifa Final de Geração</div>
                <div class="tabela-celula">Encargo Final de Carga</div>
                <div class="tabela-celula">Tarifa Final de Carga</div>
            </div>
            {% for barra in barras %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ barra.numero }}</div>
                {% if 'geracao' not in corrigido_nodal %}
                <div class="tabela-celula">{{ f(barra.encargos['geracao']['CTU'] + barra.encargos['geracao']['CTN']) }}</div>
                <div class="tabela-celula">{{ f(d((barra.encargos['geracao']['CTU'] + barra.encargos['geracao']['CTN']), barra.capacidade_instalada)) }}</div>
                {% endif %}
                {% if 'geracao' in corrigido_nodal %}
                <div class="tabela-celula">{{ f(barra.encargos['geracao']['nodal_corrigido']) }}</div>
                <div class="tabela-celula">{{ f(d(barra.encargos['geracao']['nodal_corrigido'], barra.capacidade_instalada)) }}</div>
                {% endif %}
                {% if 'carga' not in corrigido_nodal %}
                <div class="tabela-celula">{{ f(barra.encargos['carga']['CTU'] + barra.encargos['carga']['CTN']) }}</div>
                <div class="tabela-celula">{{ f(d((barra.encargos['carga']['CTU'] + barra.encargos['carga']['CTN']), barra.potencia_consumida)) }}</div>
                {% endif %}
                {% if 'carga' in corrigido_nodal %}
                <div class="tabela-celula">{{ f(barra.encargos['carga']['nodal_corrigido']) }}</div>
                <div class="tabela-celula">{{ f(d(barra.encargos['carga']['nodal_corrigido'], barra.potencia_consumida)) }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <p>Encargos totais para geração: <strong>R$ {{ f(barras.vetor_encargos_finais('geracao') | sum) }}</strong></p>
        <p>Encargos totais para carga: <strong>R$ {{ f(barras.vetor_encargos_finais('carga') | sum) }}</strong></p>
    </div>
    <!-- Tarifas Zonais -->
    <div class="conteudo">
        <h3>Tarifas Zonais</h3>
        <p>A determinação das zonas é dada de acordo com as tarifas locacionais nodais, representadas no gráfico abaixo: </p>
        <img src="nodal.png">
        <p>O número de zonas diferentes para o sistema foi dado pelo cálculo da maior curvatura do gráfico de erro do K-médias (ou "método do cotovelo"):</p>
        <img src="cotovelo.png">
        <p>A divisão do sistema em zonas se deu da seguinte forma:</p>
        {% for zona in zonas %}
        <p>Zona {{ zona.numero }}: Barras {{ zona.barras }}</p>
        {% endfor %}
        <p>Essa divisão pode ser visualizada no próprio gráfico das tarifas, agora representando cada uma das zonas por uma cor diferente:</p>
        <img src="zonal.png">
        <p>A figura abaixo oferece uma visualização da disposição das barras através das coordenadas fornecidas, coloridas de acordo com suas respectivas zonas.</p>
        <img src="posicional.png">

        <p>As tarifas do CTU são calculadas por zona, como mostrado na tabela.</p>
        <p>As tarifas do CTN são:</p>
        <p>Para geração, <strong>kg = {{ f(ctn['kg']) }}</strong></p>
        <p>Para carga, <strong>kc = {{ f(ctn['kc']) }}</strong></p>
    </div>
    <div class="conteudo">
        <h4>Dados das Zonas</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Zona</div>
                <div class="tabela-celula">Encargo Locacional de Geração</div>
                <div class="tabela-celula">Tarifa Locacional de Geração</div>
                <div class="tabela-celula">Encargo Locacional de Carga</div>
                <div class="tabela-celula">Tarifa Locacional de Carga</div>
            </div>
            {% for zona in zonas %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ zona.numero }}</div>
                <div class="tabela-celula">{{ f(zona.encargos['geracao']) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['geracao']) }}</div>
                <div class="tabela-celula">{{ f(zona.encargos['carga']) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['carga']) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="conteudo">
        <h4>Tarifas Totais das Zonas</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Zona</div>
                <div class="tabela-celula">Encargo Total de Geração</div>
                <div class="tabela-celula">Tarifa Total de Geração</div>
                <div class="tabela-celula">Encargo Total de Carga</div>
                <div class="tabela-celula">Tarifa Total de Carga</div>
            </div>
            {% for zona in zonas %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ zona.numero }}</div>
                <div class="tabela-celula">{{ f((zona.tarifas['geracao'] + ctn['kg']) * zona.barras.vetor_capacidade_instalada() | sum ) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['geracao'] + ctn['kg']) }}</div>
                <div class="tabela-celula">{{ f((zona.tarifas['carga'] + ctn['kc']) * zona.barras.vetor_potencia_consumida() | sum ) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['carga'] + ctn['kc']) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% if corrigido_zonal %}
        <div class="conteudo">
            <p>Para esse cenário operativo, foi necessário fazer a correção de encargos negativos. Os valores finais são os valores corrigidos.</p>
        </div>
    {% endif %}
    <div class="conteudo">
        <h4>Tarifas Finais das Zonas</h4>
        <div class="tabela">
            <div class="tabela-cabecalho tabela-linha">
                <div class="tabela-celula">Zona</div>
                <div class="tabela-celula">Encargo Final de Geração</div>
                <div class="tabela-celula">Tarifa Final de Geração</div>
                <div class="tabela-celula">Encargo Final de Carga</div>
                <div class="tabela-celula">Tarifa Final de Carga</div>
            </div>
            {% for zona in zonas %}
            <div class="tabela-linha">
                <div class="tabela-celula">{{ zona.numero }}</div>
                {% if 'geracao' not in corrigido_zonal %}
                <div class="tabela-celula">{{ f((zona.tarifas['geracao'] + ctn['kg']) * zona.barras.vetor_capacidade_instalada() | sum ) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['geracao'] + ctn['kg']) }}</div>
                {% endif %}
                {% if 'geracao' in corrigido_zonal %}
                <div class="tabela-celula">{{ f(zona.encargos['geracao_corrigido']) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['geracao_corrigido']) }}</div>
                {% endif %}
                {% if 'carga' not in corrigido_zonal %}
                <div class="tabela-celula">{{ f((zona.tarifas['carga'] + ctn['kc']) * zona.barras.vetor_potencia_consumida() | sum ) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['carga'] + ctn['kc']) }}</div>
                {% endif %}
                {% if 'carga' in corrigido_zonal %}
                <div class="tabela-celula">{{ f(zona.encargos['carga_corrigido']) }}</div>
                <div class="tabela-celula">{{ f(zona.tarifas['carga_corrigido']) }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <p>Encargos totais para geração: <strong>R$ {{ f(barras.vetor_encargos_finais('geracao') | sum) }}</strong></p>
        <p>Encargos totais para carga: <strong>R$ {{ f(barras.vetor_encargos_finais('carga') | sum) }}</strong></p>
    </div>
</html>
